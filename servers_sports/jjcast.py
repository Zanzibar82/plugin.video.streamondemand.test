# -*- coding: utf-8 -*-
#------------------------------------------------------------
# streamondemand - XBMC Plugin
# Conector para jjcast
# http://blog.tvalacarta.info/plugin-xbmc/pelisalacarta/
#------------------------------------------------------------

import urlparse,urllib2,urllib,re
import os

from core import scrapertools
from core import logger
from core import config
from core import unpackerjs2

DEBUG = config.get_setting("debug")

def find_url_play(data, headers):
    logger.info("[jjcast.py] find_url_play")

    cid = scrapertools.find_single_match (data, '["\']http://nn.jjcast.com/embed.php([^"\']+)"')
    if cid == '':
        return ''
    pageurl = 'http://jjcast.com/player.php' + cid

    data2 = scrapertools.cachePage(pageurl, headers=headers)
    if (DEBUG): logger.info("data2="+data2)

    # desofuscar datos
    data2 = unpackerjs2.unpackjs(data2)
    data2 = re.sub(r"myScrT.push\(\\'([^\\']+)\\'\);", r"\1", data2)
    data2 = re.sub(r"myRtk.push\(\\'([^\\']+)\\'\);", r"\1", data2)
    data2 = urllib.unquote(data2)
    if (DEBUG): logger.info("data2clean="+urllib.unquote(data2))


    rtmpurl = scrapertools.find_single_match (data2, '(rtmp://[^/]+/lives)')
    filevalue = scrapertools.find_single_match (data2, 'var myRtk=new Array\(\);(.*?)rtmp://')
    swfurl = 'http://jjcast.com/jw5/5.10.swf'

    url = '%s playpath=%s swfUrl=%s swfVfy=1 live=1 timeout=15 pageUrl=%s' % (rtmpurl, filevalue, swfurl, pageurl)
    
    return url

    '''
data2unpacked=('var myScrT=new Array();var myRtk=new Array();myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'8\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'4\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'a\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'3\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'2\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'a\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'3\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'8\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'f\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'f\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'1\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'d\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'a\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'d\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'1\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'2\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'d\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'8\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'2\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'4\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'3\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'b\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'0\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'c\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'7\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'3\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'3\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'7\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'d\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'e\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'b\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'3\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'f\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'2\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'1\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'3\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'2\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'0\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'7\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'2\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'4\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'d\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'4\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'3\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'7\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'2\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'c\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'f\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'4\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'d\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'1\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'8\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'a\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'1\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'1\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'8\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'1\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'8\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'2\');myScrT.push(\'%\');myScrT.push(\'2\');myScrT.push(\'d\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'6\');myScrT.push(\'%\');myScrT.push(\'2\');myScrT.push(\'d\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'4\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'e\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'d\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'c\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'4\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'7\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'0\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'1\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'a\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'4\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'7\');myScrT.push(\'%\');myScrT.push(\'3\');myScrT.push(\'3\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'7\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'b\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'7\');myScrT.push(\'%\');myScrT.push(\'7\');myScrT.push(\'7\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'8\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'2\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'e\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'9\');myScrT.push(\'%\');myScrT.push(\'6\');myScrT.push(\'c\');myScrT.push(\'%\');myScrT.push(\'5\');myScrT.push(\'2\');myScrT.push(\'%\');myScrT.push(\'4\');myScrT.push(\'5\');myScrT.push(\'%\');myScrT.push(\'2\');myScrT.push(\'a\');myRtk.push(\'%\');myRtk.push(\'7\');myRtk.push(\'2\');myRtk.push(\'%\');myRtk.push(\'7\');myRtk.push(\'4\');myRtk.push(\'%\');myRtk.push(\'6\');myRtk.push(\'d\');myRtk.push(\'%\');myRtk.push(\'7\');myRtk.push(\'0\');myRtk.push(\'%\');myRtk.push(\'3\');myRtk.push(\'a\');myRtk.push(\'%\');myRtk.push(\'2\');myRtk.push(\'f\');myRtk.push(\'%\');myRtk.push(\'2\');myRtk.push(\'f\');myRtk.push(\'%\');myRtk.push(\'3\');myRtk.push(\'7\');myRtk.push(\'%\');myRtk.push(\'3\');myRtk.push(\'7\');myRtk.push(\'%\');myRtk.push(\'2\');myRtk.push(\'e\');myRtk.push(\'%\');myRtk.push(\'3\');myRtk.push(\'8\');myRtk.push(\'%\');myRtk.push(\'3\');myRtk.push(\'1\');myRtk.push(\'%\');myRtk.push(\'2\');myRtk.push(\'e\');myRtk.push(\'%\');myRtk.push(\'3\');myRtk.push(\'9\');myRtk.push(\'%\');myRtk.push(\'3\');myRtk.push(\'8\');myRtk.push(\'%\');myRtk.push(\'2\');myRtk.push(\'e\');myRtk.push(\'%\');myRtk.push(\'3\');myRtk.push(\'8\');myRtk.push(\'%\');myRtk.push(\'3\');myRtk.push(\'2\');myRtk.push(\'%\');myRtk.push(\'2\');myRtk.push(\'f\');myRtk.push(\'%\');myRtk.push(\'6\');myRtk.push(\'c\');myRtk.push(\'%\');myRtk.push(\'6\');myRtk.push(\'9\');myRtk.push(\'%\');myRtk.push(\'7\');myRtk.push(\'6\');myRtk.push(\'%\');myRtk.push(\'6\');myRtk.push(\'5\');myRtk.push(\'%\');myRtk.push(\'7\');myRtk.push(\'3\');jwplayer("mediaspace").A({\'flashplayer\':"D/5.C.E",\'width\':\'640\',\'height\':\'325\',\'allowfullscreen\':\'true\',\'F\':\'always\',\'wmode\':\'B\',\'J\':\'U\',\'dock\':\'true\',\'dock.Q\':\'T\',\'P\':\'S\',\'V\':\'R\',\'N\':\'true\',\'I\':\'3\',\'H\':unescape(myScrT.join(\'\')),\'G\':unescape(myRtk.join(\'\')),\'O\':\'K.M\'});var L=0;',58,58,

data2clean=('var myScrT=new Array();var myRtk=new Array();h6etzcfy62yzs8?9oi-xCnaHIMFLJAvgnTcvb6-Wp4_TdPA19hh_oVPsPoIsRPv7RTeUM43eGRLfOdmqEhzQQ8Ai9hb-f-4NEmLtMn0l4-ZyUENnv3IN3G79LM*rtmp://89.40.71.202/livesjwplayer("mediaspace").setup({\'flashplayer\':"C/5.B.D",\'width\':\'640\',\'height\':\'325\',\'allowfullscreen\':\'true\',\'E\':\'always\',\'wmode\':\'A\',\'I\':\'T\',\'dock\':\'true\',\'dock.P\':\'S\',\'O\':\'R\',\'U\':\'Q\',\'M\':\'true\',\'H\':\'3\',\'G\':unescape(myScrT.join(\'\')),\'F\':unescape(myRtk.join(\'\')),\'N\':\'J.L\'});var K=0;',57,57,

    '''

